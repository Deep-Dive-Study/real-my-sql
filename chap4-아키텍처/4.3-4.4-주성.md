## 4.3 MyISAM 스토리지 엔진 아키텍처

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/5003c470-fbd3-454f-89ef-18c742ac0607)

### 4.3.1 키 캐시

- InnoDB의 버퍼풀과 유사한 역할

- 인덱스만을 대상으로 작동, 인덱스 디스크 쓰기 작업에 대해서만 부분적 버퍼링 역할 수행

- **`키 캐시 히트율(Hit rate)`** : 100 - (Key_reads / Key_read_requests * 100)

  - `key_reads` : 인덱스를 디스크에서 읽어 들인 횟수

  - `key_read_requests` : 키 캐시로부터 인덱스를 읽은 횟수 저장

- 히트율이 99% 미만이라면, 키 캐시를 조금 더 크게 설정하는 것이 좋음

- 더 자세한 내용은 MySQL 메뉴얼의 'Multiple Key caches'를 참고하자 

### 4.3.2 운영체제의 캐시 및 버퍼

- MyISAM 테이블의 인덱스는 키 캐시를 이용해 디스크를 검색하지 않고도 빠르게 검색할 수 있음

  - 다만, MyISAM 테이블의 데이터에 대해서는 디스크로부터 I/O를 해결해줄 만한 어떠한 캐시나 버퍼링 기능도 가지고 있지 않음
    
  - 따라서, 데이터 읽기/쓰기 작업은 항상 운영체제의 디스크 읽기/쓰기 작업으로 요청될 수밖에 없음

    - 물론, 대부분의 운영체제에는 디스크로부터 읽고 쓰는 파일에 대한 캐시나 버퍼링 메커니즘을 탑재하고 있음

    - 따라서, MySQL 서버가 요청하는 디스크 읽기 작업을 위해 매번 디스크의 파일을 읽지는 않음
  
- 운영체제의 캐시 공간은 남는 메모리를 사용하는 것이 기본 원칙
  
    - 다른 애플리케이션에서 공간을 사용한다면 MyISAM의 성능이 저하됨
      
    - 따라서, 데이터베이스에서 MyISAM 테이블을 주로 사용한다면, 운영체제가 사용할 수 있는 캐시 공간을 위한 충분한 메모리를 비워둬야 이러한 문제를 방지할 수 있음
      
### 4.3.3 데이터 파일과 프라이머리 키(인덱스) 구조

- InnoDB 스토리지 엔진을 사용하는 테이블을 PK에 의해서 클러스터링되어 저장됨
  
- MyISAM 테이블은 PK에 의한 클러스터링 없이 데이터 파일이 `힙 공간처럼 활용`됨
  
    - 레코드는 테이블에 PK와 무관하게 INSERT되는 순서대로 데이터 파일에 저장
      
    - 테이블에 저장되는 레코드는 모두 ROWID라는 물리적인 주소값을 가지고 있음
 
      - ROWID는 가변길이와 고정길이 두가지 방법으로 저장될 수 있음
  
    - PK, Secondary index는 모두 데이터 파일에 저장된 레코드의 ROWID 값을 포인터로 가진다.

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/47f36d2a-88bf-4fd3-b230-66613d033aed)

## 4.4 MySQL 로그 파일

- 로그를 통해 MySQL 상태나 부하를 일으키는 원인을 보다 쉽게 해결할 수 있음

- 따라서, 서버에 문제가 생겼을 때 로그 파일들을 자세히 확인하는 습관을 들이면 좋음 

### 4.4.1 에러 로그 파일
- MySQL 실행 도중 발생하는 에러나 경고메시지가 출력되는 로그 파일

- MySQL 설정 파일 (my.cnf)에서 `log_error` 라는 이름의 파라미터로 정의된 경로에 생성됨
  - MySQL 설정 파일에 별도로 정의되지 않은 경우에는 데이터 디렉터리에 `.err` 파일이 생성됨

- `자주 보게되는 메시지 종류들`
    - MySQL이 시작하는 과정과 관련된 정보성/에러 메시지
      
    - 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB 트랜잭션 복구 메시지
      
    - 쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지
      
    - 비정상으로 종료된 커넥션 메시지
      
    - InnoDB의 모니터링 또는 상태조회 명령의 결과 메시지
      
    - MySQL의 종료 메시지

#### 4.4.1.1 MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지
- MySQL의 설정 파일을 변경하거나 데이터베이스가 비정상적으로 종료된 이후, 다시 시작하는 경우에는 반드시 MySQL 에러 로그 파일을 통해 설정된 변수의 이름이나 값이 명확하게 설정되고 의도한 대로 적용됐는지 확인해야 함

- 정상 기동되었는지, 특정 변수에 값이 정상적으로 설정되었는지, 등

#### 4.4.1.2 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지
- MySQL 서버가 비정상적 또는 강제적으로 종료될 경우 다시 시작할 때 완료되지 못한 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터를 다시 기록하는 작업(재처리 작업)을 함

- 위 과정에서, 문제가 발생해서 복구되지 못하면 에러메시지를 출력하고 MySQL을 종료함

- 문제 해결에 대한 자세한 내용은 4.2.6절 '자동화된 장애 복구'를 참조

#### 4.4.1.3 쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지
- 사전 예방이 어려우며, 주기적으로 에러 로그 파일을 검토하는 과정에서 알 수 있음

- 쿼리 실행 도중 발생한 에러, 복제에서 문제가 될 만한 쿼리에 대한 경고 메시지가 기록됨
  - 숨겨진 문제점을 해결하는데 도움이 됨 

#### 4.4.1.4 비정상적으로 종료된 커넥션 메시지 (Aborted connection)
- 클라이언트측 프로그램이 비정상적으로 종료된 경우 MySQL 서버의 에러 로그 파일에 메시지가 기록됨

- 이런 메시지가 많이 기록된다면 애플리케이션의 커넥션 종료 로직을 검토할 필요가 있음
  - 'max_connect_errors' 변수의 값을 증가 시켜 해결할 수 있지만, 이 에러가 어떻게 발생하게 됐는지 원인을 살펴보는게 좋음 

#### 4.4.1.5 InnoDB의 모니터링 또는 상태 조회 명령 (SHOW ENGINE INNODB STATUS 같은)의 결과 메시지
- InnoDB의 테이블 모니터링이나 락 모니터링, InnoDB의 엔진 상태를 조회하는 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록하게 됨
  
- 모니터링을 활성화 상태로 유지하는 경우 에러 로그 파일이 커져서 파일 시스템의 공간을 다 사용할 수도 있음
  - (주의!) 모니터링을 사용한 이후에는 모니터링을 비활성화 상태로 변경해서 에러 로그 파일이 커지지 않도록 한다.

#### 4.4.1.6 MySQL의 종료 메시지
- 에러 로그 파일에서 MySQL이 마지막으로 종료되면서 출력한 메시지를 확인하여 원인을 파악할 수 있음

  - 왜 MySQL 서버가 종료되었는지 확인할 수 있는 유일한 방법
  
  - 누군가가 종료시켰을 경우 `Received SHUTDOWN from user ...` 라는 메시지가 뜬다.
      
  - 아무런 종료 관련 메시지가 없거나 스택 트레이스와 같은 내용이 출력되는 경우 MySQL 서버가 `Segmentation fault` 로 비정상적으로 종료된 것으로 판단할 수 있음
    - 스택 트레이스의 내용을 참조해서 MySQL 버전 업그레이드 or 회피책을 찾는 것이 방법

- 에러 로그에 대한 보다 자세한 내용은 MySQL 메뉴얼의 'The Error Log' 절을 참조
   
### 4.4.2 제너럴 쿼리 로그 파일

- 서버에서 실행되는 쿼리로 어떤것들이 있는지 검토하고 싶으면, 쿼리 로그를 활성화해서 쿼리 로그파일로 기록하게 하면 됨

- 슬로우 쿼리 로그와는 다르게 제너럴 쿼리 로그는 실행되기 전에 MySQL이 쿼리 요청을 받으면 바로 기록함
    - 따라서, 쿼리 실행 중에 에러가 발생해도 일단 로그 파일에 기록됨
      
- 쿼리 로그 파일의 경로는 `general_log_file` 이라는 파라미터에 설정할 수 있음

  ```mysql
    SHOW GLOBAL VARIABLES LIKE 'general_log_file';
  ``` 

- 파일이 아닌 테이블에 저장하도록 설정할 수도 있음
  - `log_output` 파라미터로 결정

### 4.4.3 슬로우 쿼리 로그

`MySQL의 쿼리 튜닝`
- 서비스가 적용되기 전에 전체적으로 튜닝
  - 모든 쿼리가 검토해야할 대상이므로 전부 튜닝하면 됨
      
- `서비스 운영중에 MySQL 서버의 전체적인 성능 저하를 검사하거나 정기적인 점검을 위한 튜닝`
  - **어떤 쿼리가 문제의 쿼리인지 판단하기 어려움**

  - `슬로우 쿼리 로그`를 통해 파악할 수 있음

- 쿼리의 실제 소요된 시간을 기준으로 슬로우 쿼리 로그에 기록할지 여부를 판단하여 기록함
  - 반드시 쿼리가 `정상적으로 실행이 완료`돼야 기록됨
    
  - 정상적으로 실행이 완료되었고, `long_query_time`에 정의된 시간보다 오래 걸린 쿼리가 기록됨

- `log_output` 옵션을 통해 파일로 기록할지, 테이블로 기록할지 선택할 수 있음
  - 테이블로 저장하더라도 CSV 파일로 저장하는 것과 동일하게 작동함 (CSV 스토리지 엔진 사용함)

  - 테이블로 설정하면 `general_log`, `slow_log` 테이블에 저장

`슬로우 쿼리 로그 파일 출력 형태`

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/5807aec8-8c42-4896-b48e-bff36986b2e9)

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/b216a142-2f9d-4090-acf7-ba76ce4e91db)

- MyISAM이나 MEMORY 스토리지 엔진에서는 테이블 단위 잠금을 사용하고 있어서 SELECT 쿼리라고 해도 Lock_time이 1초 이상 소요될 가능성이 있음

- 레코드 잠금을 사용하는 InnoDB도 이런 경우가 발생할 수 있는데, 이는 MySQL 엔진 레벨에서 설정한 테이블 잠금 때문일 가능성이 높음
  - 그래서 InnoDB 테이블에만 접근하는 쿼리 문장의 슬로우 쿼리 로그에서는 Lock_time 값은 튜닝이나 쿼리 분석에 별로 도움이 되지 않음

- Percona Toolkit의 pt-query-digest 스크립트를 이용하면 빈도나 처리 성능별로 쿼리를 정렬할 수 있음

```bash
## General Log 파일 분석
linux> pt-query-digest --type='genlog' general.log > parsed_general.log

## Slow Log 파일 분석
linux> pt-query-digest --type='slowlog' mysql-slow.log > parsed_mysql-slog.log
```

- 로그 파일의 분석이 완료되면 결과는 다음 3개의 그룹으로 나뉘어 저장됨

#### 4.4.3.1. 슬로우 쿼리 통계
- 분석 결과의 최상단에 표시되며, 모든 쿼리를 대상으로 슬로우 쿼리 로그의 실행 시간(Exec time), 잠금 대기 시간(Lock time) 등에 대해 평균, 최소, 최대 값을 표시

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/7513bb68-6603-46c4-af75-473640d79c3a)

#### 4.4.3.2. 실행 빈도 및 누적 실행 시간순 랭킹
- 각 쿼리별로 응답 시간과 실행 횟수를 보여줌

- `pt-query-digest` 명령을 실행해서 `--order-by` 옵션으로 정렬 순서를 변경할 수 있음

- Query ID는 실행된 쿼리 문장을 정규화(쿼리에 사용된 리터럴 제거)해서 만들어진 해시 값
  - 일반적으로 같은 모양의 쿼리라면 동일한 Query ID를 가짐

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/3ddbfe98-ab0c-4cd6-b5f6-153ffa28ee1b)

#### 4.4.3.3. 쿼리별 실행 횟수 및 누적 실행 시간 상세 정보
- QueryId별 쿼리를 쿼리 랭킹에 표시된 순서대로 자세한 내용을 보여줌
  - 개별 쿼리 정보 : 쿼리가 얼마나 실행됐는지, 쿼리의 응답 시간에 대한 히스토그램 같은 상세 내용

![image](https://github.com/Deep-Dive-Study/real-my-sql/assets/99165624/3507559f-f8e1-424f-8e6f-830a0367a401)
